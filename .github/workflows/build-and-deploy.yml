# This workflow trigger on push to any branch
name: CI / CD
on:
    push:
        paths-ignore:
            - '**.md'
            - '.gitignore'
            - 'LICENCE'
            - 'CODEOWNERS'
        branches:
    deployment:

env:
  IMAGE: docker.pkg.github.com/${{ github.repository }}/sykdom-i-familien
  GITHUB_USERNAME: x-access-token
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
    test:
        name: Test Code
        runs-on: ubuntu-latest
        strategy:
            matrix:
                node-version: [8.x]

        steps:
            - uses: actions/checkout@v1
            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v1
              with:
                  node-version: ${{ matrix.node-version }}
            - name: npm install, build, and test
              run: |
                  npm ci
                  npm run test

    build-code-and-push-docker-dev:
        name: staging-build-push-docker
        if: startsWith(github.ref, 'refs/heads/dev-') || startsWith(github.ref, 'refs/heads/master') || (github.event.deployment.environment == 'dev-sbs' && github.event.deployment.ref == 'master') # Build and push docker if publish staging event from sanity studio
        needs: test
        runs-on: ubuntu-latest
        steps:
            - name: debug deployment webhook
              run: |
                  echo "ref - ${{ github.event.deployment.ref }}"
                  echo "task - ${{ github.event.deployment.task }}"
                  echo "environment - ${{ github.event.deployment.environment }}"
            - name: Checkout code
              uses: actions/checkout@v1
            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v1
              with:
                  node-version: ${{ matrix.node-version }}
            - name: build code
              env:
                  SANITY_TOKEN: ${{ secrets.SANITY_TOKEN }}
                  DATASET: production
                  ENV: dev
                  OVERLAY_DRAFTS: true
                  WATCH_MODE: true
              run: |
                  echo "Exported DATASET=$DATASET"
                  npm i
                  npm run build
            - name: Create Docker tag
              env:
                  NAME: sykdom-i-familien
              run: |               
                  echo "::set-env name=TAG::$(date "+%Y.%m.%d.%H.%M")-$(git rev-parse --short HEAD)"
            - name: Build Docker image
              run: |
                  docker build -t ${IMAGE}:${TAG} . -f Dockerfile-dev
            - name: Login to Github Package Registry
              env:
                  DOCKER_USERNAME: x-access-token
                  DOCKER_PASSWORD: ${{ env.GITHUB_TOKEN }}
              run: |
                  echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin docker.pkg.github.com
            - name: Push Docker image
              run: 'docker push ${IMAGE}:${TAG}'

    build-code-and-push-docker-prod:
        name: prod-build-push-docker
        if: github.event.deployment.environment == 'prod-sbs' && github.event.deployment.ref == 'master' # Build and push docker if publish production event from sanity studio
        needs: test
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v1
            - name: Checkout code
              uses: actions/checkout@v1
            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v1
              with:
                  node-version: ${{ matrix.node-version }}
            - name: build code
              env:
                  SANITY_TOKEN: ${{ secrets.SANITY_TOKEN }}
                  DATASET: production
                  ENV: prod
                  OVERLAY_DRAFTS: false
                  WATCH_MODE: false
              run: |
                  echo "Exported DATASET=$DATASET"
                  npm i
                  npm run build
            - name: Create Docker tag
              env:
                  NAME: sykdom-i-familien
              run: |
                  echo "::set-env name=TAG::$(date "+%Y.%m.%d.%H.%M")-$(git rev-parse --short HEAD)"
            - name: Build Docker image
              run: |
                  docker build -t ${IMAGE}:${TAG} .
            - name: Login to Github Package Registry
              env:
                  DOCKER_USERNAME: x-access-token
                  DOCKER_PASSWORD: ${{ env.GITHUB_TOKEN }}
              run: |
                  echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin docker.pkg.github.com
            - name: Push Docker image
              run: 'docker push -t ${IMAGE}:${TAG}'

    deploy-dev-sbs:
        name: deploy-dev-sbs
        needs: build-code-and-push-docker-dev # Depends on build-code-and-push-docker job
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v1
            - name: deploy to dev-sbs
              uses: nais/deploy/actions/deploy@v1
              env:
                APIKEY: ${{ secrets.NAIS_DEPLOY_APIKEY }}
                CLUSTER: dev-sbs
                RESOURCE: nais/dev-sbs.yml

    deploy-prod-sbs:
        name: deploy-prod-sbs
        needs: build-code-and-push-docker-prod # Depends on build-code-and-push-docker job
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v1
            - name: deploy to prod-sbs
              uses: nais/deploy/actions/deploy@v1
              env:
                APIKEY: ${{ secrets.NAIS_DEPLOY_APIKEY }}
                CLUSTER: prod-sbs
                RESOURCE: nais/prod-sbs.yml
